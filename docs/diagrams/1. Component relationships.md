# Component relationships
### 1. Core runtime layer
   SynapseRuntime: orchestrates ingestion, rule processing, and pattern detection
   Manages: EventNetwork, StructuralMemory, Rules, PatternWatcher[]
### 2. Storage layer
   - EventNetwork: DAG interface for events and relationships
   - InMemoryEventNetwork: concrete implementation
   - MemoizedNetwork: caching wrapper around the base network
   - StructuralMemory: tracks structural changes and motif occurrences
   - PatternMemory: extends StructuralMemory with lineage signatures
### 3. Rule processing pipeline
   - DeriveEventRule: processes events and evaluates conditions
   - ConditionCompiler: compiles Condition DSL into EventExpression
   - EventExpression: evaluates conditions against the network
### 4. Pattern recognition pipeline
   - PatternWatcher: observes materialized events and detects repeating patterns
   - PatternListener: receives pattern match notifications
   - CompositePatternListener: forwards matches to multiple watchers
### 5. Pattern composition pipeline
   - PatternCompositionWatcher: detects when multiple patterns are recognized together
   - Uses Synapse.Ingest to create derived events when compositions are detected
### 6. Event flow
   - Event ingested → added to network
   - Memory notified → updates caches
   - Rules processed → conditions evaluated
   - Derived events materialized → added to network
   - Memory updated → pattern signatures computed
   - Pattern watchers notified → pattern detection
   - Pattern matches forwarded → composition checking
   -Composition events created → cycle repeats
   
This diagram shows the main components, their relationships, and the event processing flow through the system.

```mermaid
graph TB
    %% Core Runtime
    subgraph "Core Runtime"
        SR[SynapseRuntime]
        SR --> |uses| EN[EventNetwork]
        SR --> |uses| MEM[StructuralMemory]
        SR --> |manages| RULES[Rules Map]
        SR --> |notifies| PW[PatternWatcher Array]
    end

    %% Storage Layer
    subgraph "Storage Layer"
        EN --> |implements| IMN[InMemoryEventNetwork]
        EN --> |wrapped by| MN[MemoizedNetwork]
        MN --> |delegates to| IMN
        MN --> |updates| MEM
        MEM --> |extends| PM[PatternMemory]
        PM --> |implements| IMSM[InMemoryStructuralMemory]
    end

    %% Rule Processing Pipeline
    subgraph "Rule Processing"
        RULES --> |contains| DER[DeriveEventRule]
        DER --> |uses| CC[ConditionCompiler]
        CC --> |creates| EE[EventExpression]
        CC --> |queries| EN
        EE --> |evaluates against| EN
        DER --> |binds to| EN
    end

    %% Condition DSL
    subgraph "Condition DSL"
        COND[Condition]
        COND --> |compiled by| CC
        COND --> |supports| HASPEERS[HasPeers]
        COND --> |supports| HASSIBLINGS[HasSiblings]
        COND --> |supports| HASCHILD[HasChild]
        COND --> |supports| HASDESCENDANTS[HasDescendants]
    end

    %% Pattern Recognition Pipeline
    subgraph "Pattern Recognition"
        PW --> |implements| PO[PatternObserver]
        PW --> |queries| PM
        PW --> |notifies| PL[PatternListener]
        PL --> |implements| PLPOC[PatternListenerPoc]
        PL --> |forwards to| CPL[CompositePatternListener]
    end

    %% Pattern Composition Pipeline
    subgraph "Pattern Composition"
        CPL --> |forwards to| PCW[PatternCompositionWatcher]
        PCW --> |uses| PCS[PatternCompositionSpec]
        PCW --> |creates events via| SR
        PCW --> |notifies| PCL[PatternCompositionListener]
    end

    %% Event Flow
    subgraph "Event Flow"
        INGEST[Ingest Event] --> |1. Add to| EN
        INGEST --> |2. Notify| MEM
        INGEST --> |3. Process| RULES
        RULES --> |4. Materialize| DERIVED[Derived Event]
        DERIVED --> |5. Add to| EN
        DERIVED --> |6. Notify| MEM
        DERIVED --> |7. Notify| PW
        PW --> |8. Detect pattern| PATTERN[Pattern Match]
        PATTERN --> |9. Forward to| CPL
        CPL --> |10. Check composition| PCW
        PCW --> |11. Create event| INGEST
    end

    %% Caching Layer
    subgraph "Caching"
        MN --> |uses| PC[PatternCache]
        PC --> |caches| RELATIONS[Relation Queries]
        MEM --> |invalidates| PC
    end

    %% Styling
    classDef runtime fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef storage fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef rule fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef pattern fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef composition fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class SR runtime
    class EN,IMN,MN,MEM,PM,IMSM storage
    class RULES,DER,CC,EE,COND rule
    class PW,PO,PL,PLPOC,CPL pattern
    class PCW,PCS,PCL composition

```